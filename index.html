<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Babai Messenger | Call</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <style>
        :root {
            --wa-bg: #0b141a;
            --wa-panel: #202c33;
            --wa-msg-in: #202c33;
            --wa-msg-out: #005c4b;
            --wa-accent: #00a884;
            --wa-text: #e9edef;
            --wa-danger: #ea0038;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: -apple-system, sans-serif; background: var(--wa-bg); color: var(--wa-text); overflow: hidden; }

        /* --- Login/Chat UI (Same as before) --- */
        #login-screen { position: fixed; inset: 0; background: var(--wa-bg); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .login-card { background: var(--wa-panel); padding: 30px; border-radius: 20px; width: 100%; max-width: 360px; text-align: center; }
        input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; border: 1px solid #333; background: #2a3942; color: white; font-size: 16px; outline: none; }
        .btn-join { width: 100%; padding: 15px; border: none; border-radius: 10px; background: var(--wa-accent); color: white; font-weight: bold; cursor: pointer; }

        #chat-app { display: none; flex-direction: column; height: 100vh; height: -webkit-fill-available; }
        header { background: var(--wa-panel); padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; height: 65px; border-bottom: 1px solid #333; }
        #chat-window { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; }
        .msg { max-width: 80%; padding: 10px; border-radius: 12px; font-size: 15px; line-height: 1.4; }
        .sent { align-self: flex-end; background: var(--wa-msg-out); }
        .received { align-self: flex-start; background: var(--wa-msg-in); }

        /* --- Calling UI --- */
        #call-overlay {
            position: fixed; inset: 0; background: #000; z-index: 1500; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video {
            position: absolute; top: 20px; right: 20px; width: 100px; height: 150px;
            background: #222; border-radius: 10px; object-fit: cover; 
            transform: scaleX(-1); /* Mirror view */
            border: 2px solid var(--wa-accent);
        }
        .call-controls {
            position: absolute; bottom: 40px; display: flex; gap: 20px;
        }
        .btn-call { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-hangup { background: var(--wa-danger); }
        .btn-cam { background: #444; }

        footer { background: var(--wa-panel); padding: 10px; display: flex; gap: 10px; align-items: center; }
        .input-box { flex: 1; background: #2a3942; border-radius: 20px; padding: 0 15px; }
        #messageInput { width: 100%; border: none; background: transparent; color: white; padding: 10px 0; outline: none; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h2 style="color: var(--wa-accent)">Babai Messenger</h2>
            <input type="text" id="userName" placeholder="Your Name">
            <input type="text" id="chatCode" placeholder="Secret Code">
            <button class="btn-join" id="joinBtn">CONNECT</button>
        </div>
    </div>

    <div id="call-overlay">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
        <div class="call-controls">
            <button class="btn-call btn-hangup" onclick="endCall()">ðŸš«</button>
        </div>
    </div>

    <div id="chat-app">
        <header>
            <div id="room-info"><b>Babai Messenger</b></div>
            <div style="display: flex; gap: 15px;">
                <button onclick="startCall(true)" style="background:none; border:none; font-size:20px; cursor:pointer;">ðŸ“¹</button>
                <button onclick="startCall(false)" style="background:none; border:none; font-size:20px; cursor:pointer;">ðŸ“ž</button>
            </div>
        </header>

        <div id="chat-window"></div>

        <footer>
            <div class="input-box"><input type="text" id="messageInput" placeholder="Message"></div>
            <button onclick="sendMessage()" style="background:var(--wa-accent); border:none; color:white; padding:10px 15px; border-radius:50%;">ðŸš€</button>
        </footer>
    </div>

    <script>
        let peer, conn, currentCall;
        let myStream;
        let myName, secretCode;

        const config = { config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] } };

        document.getElementById('joinBtn').addEventListener('click', () => {
            myName = document.getElementById('userName').value.trim();
            secretCode = document.getElementById('chatCode').value.trim().toLowerCase();
            if (!myName || !secretCode) return alert("Fill Name and Code");

            const roomId = "babai-call-" + secretCode;
            peer = new Peer(roomId, config);

            peer.on('open', () => { showChat(); });
            peer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    peer = new Peer(null, config);
                    peer.on('open', () => {
                        conn = peer.connect(roomId);
                        setupEvents();
                        showChat();
                    });
                }
            });

            peer.on('connection', (c) => { conn = c; setupEvents(); });
            
            // Handle Incoming Call
            peer.on('call', (call) => {
                if(confirm("Incoming Call from Partner! Answer?")) {
                    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
                        myStream = stream;
                        call.answer(stream);
                        document.getElementById('call-overlay').style.display = 'flex';
                        document.getElementById('local-video').srcObject = stream;
                        call.on('stream', remoteStream => {
                            document.getElementById('remote-video').srcObject = remoteStream;
                        });
                        currentCall = call;
                    });
                }
            });
        });

        function showChat() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('chat-app').style.display = 'flex';
        }

        async function startCall(video) {
            try {
                myStream = await navigator.mediaDevices.getUserMedia({ video: video, audio: true });
                document.getElementById('call-overlay').style.display = 'flex';
                document.getElementById('local-video').srcObject = myStream;
                
                const targetId = "babai-call-" + secretCode;
                const call = peer.call(targetId, myStream);
                
                call.on('stream', remoteStream => {
                    document.getElementById('remote-video').srcObject = remoteStream;
                });
                currentCall = call;
            } catch (err) { alert("Camera/Mic Permission Denied"); }
        }

        function endCall() {
            if (currentCall) currentCall.close();
            if (myStream) myStream.getTracks().forEach(track => track.stop());
            document.getElementById('call-overlay').style.display = 'none';
        }

        function setupEvents() {
            conn.on('data', (data) => appendMsg(data, 'received'));
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            if(!input.value.trim()) return;
            const data = { text: input.value, sender: myName };
            conn.send(data);
            appendMsg(data, 'sent');
            input.value = "";
        }

        function appendMsg(data, type) {
            const win = document.getElementById('chat-window');
            win.innerHTML += `<div class="msg ${type}">${data.text}</div>`;
            win.scrollTop = win.scrollHeight;
            if(type === 'received' && "vibrate" in navigator) navigator.vibrate(100);
        }
    </script>
</body>
</html>
